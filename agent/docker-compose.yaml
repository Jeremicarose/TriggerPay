services:
  # shade-agent-api must always be first — it's the TEE sidecar that handles
  # NEAR account derivation, code hash attestation, and Chain Signatures signing.
  shade-agent-api:
    environment:
      NEAR_ACCOUNT_ID: ${NEAR_ACCOUNT_ID}
      NEAR_SEED_PHRASE: ${NEAR_SEED_PHRASE}
      API_CODEHASH: ${API_CODEHASH}
      APP_CODEHASH: ${APP_CODEHASH}
      NEXT_PUBLIC_contractId: ${NEXT_PUBLIC_contractId}
      NEAR_RPC_JSON: ${NEAR_RPC_JSON}
    platform: linux/amd64
    image: mattdlockyer/shade-agent-api@sha256:a86e3a4300b069c08d629a38d61a3d780f7992eaf36aa505e4527e466553e2e5
    container_name: shade-agent-api
    volumes:
      - /var/run/tappd.sock:/var/run/tappd.sock
    restart: always

  # Our TriggerPay agent — monitors flights, triggers Chain Signature payouts
  triggerpay-agent:
    environment:
      NEXT_PUBLIC_contractId: ${NEXT_PUBLIC_contractId}
      TRIGGERPAY_CONTRACT_ID: ${TRIGGERPAY_CONTRACT_ID:-triggerpay.testnet}
      FLIGHT_API_URL: ${FLIGHT_API_URL:-http://localhost:3000}
      POLL_INTERVAL_MS: ${POLL_INTERVAL_MS:-15000}
    platform: linux/amd64
    image: triggerpay/agent:latest
    container_name: triggerpay-agent
    ports:
      - "3001:3001"
    volumes:
      - /var/run/tappd.sock:/var/run/tappd.sock
    restart: always
